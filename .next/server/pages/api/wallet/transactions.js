"use strict";(()=>{var e={};e.id=315,e.ids=[315],e.modules={8770:e=>{e.exports=require("@nhost/nhost-js")},8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},2113:e=>{e.exports=require("next-auth/next")},7449:e=>{e.exports=require("next-auth/providers/credentials")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5900:e=>{e.exports=require("pg")},5831:(e,r,s)=>{s.r(r),s.d(r,{config:()=>f,default:()=>d,routeModule:()=>h});var o={};s.r(o),s.d(o,{default:()=>c});var a=s(1802),t=s(7153),n=s(6249),i=s(2113),l=s(3857),u=s(5900);async function c(e,r){if(console.log("\uD83D\uDD0D Wallet Transactions API called"),"GET"!==e.method)return r.status(405).json({message:"Method not allowed"});try{let s=await (0,i.getServerSession)(e,r,l.authOptions);if(console.log("\uD83D\uDD10 Session debug:",{hasSession:!!s,hasUser:!!s?.user,userEmail:s?.user?.email,sessionKeys:s?Object.keys(s):[],userKeys:s?.user?Object.keys(s.user):[]}),!s?.user?.email)return console.log("❌ Unauthorized - no session or email"),r.status(401).json({message:"Unauthorized"});console.log("\uD83D\uDCB3 Fetching wallet transactions for:",s.user.email);let o=new u.Client({host:"sbpnfqrsnvtyvkgldcco.db.eu-central-1.nhost.run",port:parseInt("5432"),database:"sbpnfqrsnvtyvkgldcco",user:"postgres",password:"Provenvalueenterprise@123!",ssl:{rejectUnauthorized:!1}});await o.connect();let a=`
      SELECT u.id FROM auth.users u WHERE u.email = $1
    `,t=await o.query(a,[s.user.email]);if(console.log("\uD83D\uDC64 User lookup result:",{email:s.user.email,found:t.rows.length>0,userId:t.rows[0]?.id}),0===t.rows.length)return await o.end(),r.status(404).json({message:"User not found"});let n=t.rows[0].id,c=Math.min(parseInt(e.query.limit)||50,100),d=`
      SELECT 
        id,
        transaction_type,
        type,
        amount,
        balance_before,
        balance_after,
        reference,
        status,
        description,
        payment_method,
        external_reference,
        created_at,
        updated_at
      FROM wallet_transactions 
      WHERE user_id = $1 
      ORDER BY created_at DESC 
      LIMIT $2
    `,f=await o.query(d,[n,c]);await o.end(),console.log(`💳 Found ${f.rows.length} transactions for ${s.user.email}`),r.status(200).json({success:!0,transactions:f.rows,count:f.rows.length})}catch(e){console.error("❌ Error fetching wallet transactions:",e),r.status(500).json({success:!1,message:"Failed to fetch transactions"})}}let d=(0,n.l)(o,"default"),f=(0,n.l)(o,"config"),h=new a.PagesAPIRouteModule({definition:{kind:t.x.PAGES_API,page:"/api/wallet/transactions",pathname:"/api/wallet/transactions",bundlePath:"",filename:""},userland:o})},6755:(e,r,s)=>{s.d(r,{qS:()=>o});let o=new(s(8770)).NhostClient({subdomain:"sbpnfqrsnvtyvkgldcco",region:"eu-central-1"});parseInt("5432")},3857:(e,r,s)=>{s.r(r),s.d(r,{authOptions:()=>u,default:()=>c});var o=s(3227),a=s.n(o),t=s(7449),n=s.n(t),i=s(6755),l=s(7725);let u={providers:[n()({name:"credentials",credentials:{identifier:{label:"Email or Phone",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(console.log("\uD83D\uDD10 NextAuth authorize called with:",{identifier:e?.identifier}),!e?.identifier||!e?.password)return console.log("❌ Missing credentials"),null;try{if(e.identifier.includes("@"))try{console.log("\uD83D\uDD10 Attempting Nhost authentication for:",e.identifier),console.log("\uD83C\uDF10 Nhost Config:",{subdomain:"sbpnfqrsnvtyvkgldcco",region:"eu-central-1",useNhost:"true"});let r=await i.qS.auth.signIn({email:e.identifier,password:e.password});if(console.log("\uD83D\uDCCB Nhost auth response:",{hasError:!!r.error,hasSession:!!r.session,hasUser:!!r.session?.user,error:r.error}),r.error)throw console.error("❌ Nhost auth error details:",{message:r.error.message,status:r.error.status,error:r.error}),Error(`Nhost authentication failed: ${r.error.message||"Unknown error"}`);if(r.session?.user){console.log("✅ Nhost authentication successful for user:",r.session.user.email),console.log("\uD83D\uDD0D Fetching user profile data from direct database...");let s=await l.H.findUserByEmail(e.identifier);if(s)return console.log("✅ User profile found, returning complete user data"),{id:s.id,email:s.email,name:s.display_name,phone:s.phone||"",walletBalance:s.walletBalance||0,bonusWallet:s.bonusWallet||0,totalReferrals:s.totalReferrals||0,referralCode:s.referralCode||"",emailVerified:!!s.emailVerified,accessToken:r.session.accessToken,refreshToken:r.session.refreshToken};return console.log("⚠️ User authenticated but no profile found in userStore"),{id:r.session.user.id,email:r.session.user.email||"",name:r.session.user.displayName||"",phone:"",walletBalance:0,bonusWallet:0,totalReferrals:0,referralCode:"",emailVerified:!!r.session.user.emailVerified,accessToken:r.session.accessToken,refreshToken:r.session.refreshToken}}throw console.error("❌ Nhost auth response missing session or user"),Error("Nhost authentication incomplete - no session returned")}catch(e){console.error("❌ Nhost authentication failed with error:",e),console.error("\uD83D\uDD04 Falling back to userStore authentication")}else console.log("⏭️ Nhost authentication skipped (phone login or NEXT_PUBLIC_USE_NHOST=false)");console.log("\uD83D\uDD04 Using direct database authentication for:",e.identifier);let r=await l.H.findUserByEmailOrPhone(e.identifier);if(!r)throw console.log("❌ User not found in database"),Error("Invalid credentials");if(!await l.H.verifyPasswordByEmailOrPhone(e.identifier,e.password))throw console.log("❌ Invalid password"),Error("Invalid credentials");return console.log("✅ Direct database authentication successful"),{id:r.id,email:r.email,name:r.display_name,phone:r.phone||"",walletBalance:r.walletBalance||0,bonusWallet:r.bonusWallet||0,totalReferrals:r.totalReferrals||0,referralCode:r.referralCode||"",emailVerified:!!r.emailVerified}}catch(e){return console.error("Authentication error:",e),null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.phone=r.phone,e.walletBalance=r.walletBalance,e.bonusWallet=r.bonusWallet,e.totalReferrals=r.totalReferrals,e.referralCode=r.referralCode,e.emailVerified=!!r.emailVerified,e.accessToken=r.accessToken,e.refreshToken=r.refreshToken),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.id,e.user.phone=r.phone,e.user.walletBalance=r.walletBalance,e.user.bonusWallet=r.bonusWallet,e.user.totalReferrals=r.totalReferrals,e.user.referralCode=r.referralCode,e.user.emailVerified=r.emailVerified,e.accessToken=r.accessToken,e.refreshToken=r.refreshToken),e)},pages:{signIn:"/login",error:"/auth/error"},secret:process.env.NEXTAUTH_SECRET},c=a()(u)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var s=e=>r(r.s=e),o=r.X(0,[2002],()=>s(5831));module.exports=o})();