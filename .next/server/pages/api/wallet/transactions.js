"use strict";(()=>{var e={};e.id=315,e.ids=[315],e.modules={8432:e=>{e.exports=require("bcryptjs")},3227:e=>{e.exports=require("next-auth")},2113:e=>{e.exports=require("next-auth/next")},145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},5900:e=>{e.exports=require("pg")},5831:(e,r,s)=>{s.r(r),s.d(r,{config:()=>f,default:()=>c,routeModule:()=>h});var a={};s.r(a),s.d(a,{default:()=>d});var t=s(1802),n=s(7153),o=s(6249),l=s(2113),i=s(3515),u=s(5900);async function d(e,r){if(console.log("\uD83D\uDD0D Wallet Transactions API called"),"GET"!==e.method)return r.status(405).json({message:"Method not allowed"});try{let s=await (0,l.getServerSession)(e,r,i.authOptions);if(console.log("\uD83D\uDD10 Session debug:",{hasSession:!!s,hasUser:!!s?.user,userEmail:s?.user?.email,sessionKeys:s?Object.keys(s):[],userKeys:s?.user?Object.keys(s.user):[]}),!s?.user?.email)return console.log("❌ Unauthorized - no session or email"),r.status(401).json({message:"Unauthorized"});console.log("\uD83D\uDCB3 Fetching wallet transactions for:",s.user.email);let a=new u.Client({host:"sbpnfqrsnvtyvkgldcco.db.eu-central-1.nhost.run",port:parseInt("5432"),database:"sbpnfqrsnvtyvkgldcco",user:"postgres",password:"Provenvalueenterprise@123!",ssl:{rejectUnauthorized:!1}});await a.connect();let t=`
      SELECT u.id FROM auth.users u WHERE u.email = $1
    `,n=await a.query(t,[s.user.email]);if(console.log("\uD83D\uDC64 User lookup result:",{email:s.user.email,found:n.rows.length>0,userId:n.rows[0]?.id}),0===n.rows.length)return await a.end(),r.status(404).json({message:"User not found"});let o=n.rows[0].id,d=Math.min(parseInt(e.query.limit)||50,100),c=`
      SELECT 
        id,
        transaction_type,
        type,
        amount,
        balance_before,
        balance_after,
        reference,
        status,
        description,
        payment_method,
        external_reference,
        created_at,
        updated_at
      FROM wallet_transactions 
      WHERE user_id = $1 
      ORDER BY created_at DESC 
      LIMIT $2
    `,f=await a.query(c,[o,d]);await a.end(),console.log(`💳 Found ${f.rows.length} transactions for ${s.user.email}`),r.status(200).json({success:!0,transactions:f.rows,count:f.rows.length})}catch(e){console.error("❌ Error fetching wallet transactions:",e),r.status(500).json({success:!1,message:"Failed to fetch transactions"})}}let c=(0,o.l)(a,"default"),f=(0,o.l)(a,"config"),h=new t.PagesAPIRouteModule({definition:{kind:n.x.PAGES_API,page:"/api/wallet/transactions",pathname:"/api/wallet/transactions",bundlePath:"",filename:""},userland:a})},946:(e,r,s)=>{s.d(r,{qS:()=>a});let a=new(require("@nhost/nhost-js")).NhostClient({subdomain:"sbpnfqrsnvtyvkgldcco",region:"eu-central-1"});parseInt("5432")},3515:(e,r,s)=>{s.r(r),s.d(r,{authOptions:()=>i,default:()=>u});var a=s(3227),t=s.n(a);let n=require("next-auth/providers/credentials");var o=s.n(n);s(946);var l=s(7725);let i={providers:[o()({name:"credentials",credentials:{identifier:{label:"Email or Phone",type:"text"},password:{label:"Password",type:"password"}},async authorize(e){if(console.log("\uD83D\uDD10 NextAuth authorize called with:",{identifier:e?.identifier}),!e?.identifier||!e?.password)return console.log("❌ Missing credentials"),null;try{e.identifier.includes("@"),console.log("⏭️ Nhost authentication skipped (phone login or NEXT_PUBLIC_USE_NHOST=false)"),console.log("\uD83D\uDD04 Using direct database authentication for:",e.identifier);let r=await l.H.findUserByEmailOrPhone(e.identifier);if(!r)throw console.log("❌ User not found in database"),Error("Invalid credentials");if(!await l.H.verifyPasswordByEmailOrPhone(e.identifier,e.password))throw console.log("❌ Invalid password"),Error("Invalid credentials");return console.log("✅ Direct database authentication successful"),{id:r.id,email:r.email,name:r.display_name,phone:r.phone||"",walletBalance:r.walletBalance||0,bonusWallet:r.bonusWallet||0,totalReferrals:r.totalReferrals||0,referralCode:r.referralCode||"",emailVerified:!!r.emailVerified}}catch(e){return console.error("Authentication error:",e),null}}})],session:{strategy:"jwt",maxAge:2592e3},callbacks:{jwt:async({token:e,user:r})=>(r&&(e.id=r.id,e.phone=r.phone,e.walletBalance=r.walletBalance,e.bonusWallet=r.bonusWallet,e.totalReferrals=r.totalReferrals,e.referralCode=r.referralCode,e.emailVerified=!!r.emailVerified,e.accessToken=r.accessToken,e.refreshToken=r.refreshToken),e),session:async({session:e,token:r})=>(r&&(e.user.id=r.id,e.user.phone=r.phone,e.user.walletBalance=r.walletBalance,e.user.bonusWallet=r.bonusWallet,e.user.totalReferrals=r.totalReferrals,e.user.referralCode=r.referralCode,e.user.emailVerified=r.emailVerified,e.accessToken=r.accessToken,e.refreshToken=r.refreshToken),e)},pages:{signIn:"/login",error:"/auth/error"},secret:process.env.NEXTAUTH_SECRET},u=t()(i)}};var r=require("../../../webpack-api-runtime.js");r.C(e);var s=e=>r(r.s=e),a=r.X(0,[2002],()=>s(5831));module.exports=a})();