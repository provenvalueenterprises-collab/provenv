"use strict";(()=>{var e={};e.id=7,e.ids=[7],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},7618:e=>{e.exports=import("bcryptjs")},8678:e=>{e.exports=import("pg")},6249:(e,a)=>{Object.defineProperty(a,"l",{enumerable:!0,get:function(){return function e(a,r){return r in a?a[r]:"then"in a&&"function"==typeof a.then?a.then(a=>e(a,r)):"function"==typeof a&&"default"===r?a:void 0}}})},1333:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.r(a),r.d(a,{config:()=>u,default:()=>c,routeModule:()=>d});var l=r(1802),s=r(7153),i=r(6249),n=r(5614),o=e([n]);n=(o.then?(await o)():o)[0];let c=(0,i.l)(n,"default"),u=(0,i.l)(n,"config"),d=new l.PagesAPIRouteModule({definition:{kind:s.x.PAGES_API,page:"/api/auth/register",pathname:"/api/auth/register",bundlePath:"",filename:""},userland:n});t()}catch(e){t(e)}})},122:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{t:()=>o});var l=r(8678),s=r(7618),i=e([l,s]);[l,s]=i.then?(await i)():i;class n{constructor(){this.pool=new l.Pool({host:"sbpnfqrsnvtyvkgldcco.db.eu-central-1.nhost.run",port:parseInt("5432"),database:"sbpnfqrsnvtyvkgldcco",user:"postgres",password:"Provenvalueenterprise@123!",ssl:!0,max:10,min:2,idleTimeoutMillis:6e4,connectionTimeoutMillis:1e4,query_timeout:3e4,allowExitOnIdle:!0}),this.testConnection()}async testConnection(){try{let e=await this.pool.connect();console.log("✅ Direct PostgreSQL connection established"),e.release()}catch(e){console.error("❌ Direct PostgreSQL connection failed:",e)}}async findUserByEmail(e){try{let a=`
        SELECT
          u.id,
          u.display_name,
          u.email,
          u.phone_number,
          u.password_hash,
          u.email_verified,
          u.created_at,
          up.phone,
          up.wallet_balance,
          up.bonus_wallet,
          up.total_referrals,
          up.referral_code,
          up.fast_track_eligible,
          up.fast_track_activated
        FROM auth.users u
        LEFT JOIN public.users_profiles up ON u.id = up.user_id
        WHERE u.email = $1
      `,r=await this.pool.query(a,[e]);if(0===r.rows.length)return null;let t=r.rows[0];return{id:t.id,display_name:t.display_name,email:t.email,phone_number:t.phone_number,password_hash:t.password_hash,email_verified:t.email_verified,created_at:t.created_at,phone:t.phone,wallet_balance:t.wallet_balance||0,bonus_wallet:t.bonus_wallet||0,total_referrals:t.total_referrals||0,referral_code:t.referral_code,fast_track_eligible:t.fast_track_eligible||!1,fast_track_activated:t.fast_track_activated||!1}}catch(e){return console.error("❌ Error finding user by email:",e),null}}async createUser(e){let a=await this.pool.connect();try{await a.query("BEGIN");let r=await s.default.hash(e.password,12),t=`
        INSERT INTO auth.users (
          display_name,
          email,
          phone_number,
          password_hash,
          email_verified,
          phone_number_verified,
          locale,
          avatar_url
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
        RETURNING id, display_name, email, phone_number, password_hash, email_verified, created_at
      `,l=[e.display_name,e.email,e.phone_number||null,r,!1,!1,"en",""],i=(await a.query(t,l)).rows[0],n=this.generateReferralCode(),o=`
        INSERT INTO public.users_profiles (
          user_id,
          phone,
          wallet_balance,
          bonus_wallet,
          total_referrals,
          referral_code,
          fast_track_eligible,
          fast_track_activated
        ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8)
        RETURNING phone, wallet_balance, bonus_wallet, total_referrals, referral_code, fast_track_eligible, fast_track_activated
      `,c=[i.id,e.phone||null,0,0,0,n,!1,!1],u=(await a.query(o,c)).rows[0];return await a.query("COMMIT"),{id:i.id,display_name:i.display_name,email:i.email,phone_number:i.phone_number,password_hash:i.password_hash,email_verified:i.email_verified,created_at:i.created_at,phone:u.phone,wallet_balance:u.wallet_balance,bonus_wallet:u.bonus_wallet,total_referrals:u.total_referrals,referral_code:u.referral_code,fast_track_eligible:u.fast_track_eligible,fast_track_activated:u.fast_track_activated}}catch(e){return await a.query("ROLLBACK"),console.error("❌ Error creating user:",e),null}finally{a.release()}}async verifyPassword(e,a){try{let r=await this.findUserByEmail(e);if(!r||!r.password_hash)return!1;return await s.default.compare(a,r.password_hash)}catch(e){return console.error("❌ Error verifying password:",e),!1}}async updateUserProfile(e,a){let r=await this.pool.connect();try{await r.query("BEGIN");let t={},l={};if(Object.entries(a).forEach(([e,a])=>{["display_name","email","phone_number","password_hash","email_verified"].includes(e)?t[e]=a:["phone","wallet_balance","bonus_wallet","total_referrals","referral_code","fast_track_eligible","fast_track_activated"].includes(e)&&(l[e]=a)}),Object.keys(t).length>0){let a=Object.keys(t).map((e,a)=>`${e} = $${a+1}`).join(", "),l=Object.values(t);l.push(e);let s=`UPDATE auth.users SET ${a} WHERE id = $${l.length}`;await r.query(s,l)}if(Object.keys(l).length>0){let a=Object.keys(l).map((e,a)=>`${e} = $${a+1}`).join(", "),t=Object.values(l);t.push(e);let s=`UPDATE public.users_profiles SET ${a} WHERE user_id = $${t.length}`;await r.query(s,t)}return await r.query("COMMIT"),!0}catch(e){return await r.query("ROLLBACK"),console.error("❌ Error updating user profile:",e),!1}finally{r.release()}}generateReferralCode(){return Math.random().toString(36).substring(2,8).toUpperCase()}async close(){await this.pool.end()}}let o=new n;t()}catch(e){t(e)}})},1850:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.d(a,{H:()=>n});var l=r(122),s=e([l]);l=(s.then?(await s)():s)[0];class i{async findUserByEmail(e){try{console.log("\uD83D\uDD0D Finding user by email:",e);let a=await l.t.findUserByEmail(e);if(a)return{id:a.id,display_name:a.display_name,email:a.email,phone:a.phone,phone_number:a.phone_number,passwordHash:a.password_hash,referralCode:a.referral_code,emailVerified:a.email_verified,createdAt:a.created_at,walletBalance:a.wallet_balance,bonusWallet:a.bonus_wallet,totalReferrals:a.total_referrals,fastTrackEligible:a.fast_track_eligible,fastTrackActivated:a.fast_track_activated};return null}catch(e){return console.error("❌ Error finding user by email:",e),null}}async createUser(e){try{console.log("\uD83D\uDC64 Creating new user:",e.email);let a=await l.t.createUser(e);if(a)return{id:a.id,display_name:a.display_name,email:a.email,phone:a.phone,phone_number:a.phone_number,passwordHash:a.password_hash,referralCode:a.referral_code,emailVerified:a.email_verified,createdAt:a.created_at,walletBalance:a.wallet_balance,bonusWallet:a.bonus_wallet,totalReferrals:a.total_referrals,fastTrackEligible:a.fast_track_eligible,fastTrackActivated:a.fast_track_activated};return null}catch(e){return console.error("❌ Error creating user:",e),null}}async updateUserProfile(e,a){try{console.log("\uD83D\uDCDD Updating user profile:",e);let r={};return a.display_name&&(r.display_name=a.display_name),a.email&&(r.email=a.email),a.phone&&(r.phone=a.phone),a.phone_number&&(r.phone_number=a.phone_number),a.passwordHash&&(r.password_hash=a.passwordHash),a.referralCode&&(r.referral_code=a.referralCode),void 0!==a.emailVerified&&(r.email_verified=a.emailVerified),void 0!==a.walletBalance&&(r.wallet_balance=a.walletBalance),void 0!==a.bonusWallet&&(r.bonus_wallet=a.bonusWallet),void 0!==a.totalReferrals&&(r.total_referrals=a.totalReferrals),void 0!==a.fastTrackEligible&&(r.fast_track_eligible=a.fastTrackEligible),void 0!==a.fastTrackActivated&&(r.fast_track_activated=a.fastTrackActivated),await l.t.updateUserProfile(e,r)}catch(e){return console.error("❌ Error updating user profile:",e),!1}}async verifyPassword(e,a){try{return console.log("\uD83D\uDD10 Verifying password for:",e),await l.t.verifyPassword(e,a)}catch(e){return console.error("❌ Error verifying password:",e),!1}}}let n=new i;t()}catch(e){t(e)}})},5614:(e,a,r)=>{r.a(e,async(e,t)=>{try{r.r(a),r.d(a,{default:()=>i});var l=r(1850),s=e([l]);async function i(e,a){if("POST"!==e.method)return a.status(405).json({message:"Method not allowed"});let{name:r,email:t,phone:s,password:i,referral_code:n}=e.body;if(console.log("\uD83D\uDCCB Registration request body:",{name:r,email:t,phone:s?"provided":"missing",password:i?"provided":"missing",referral_code:n}),!r||!t||!s||!i)return console.log("❌ Missing required fields:",{name:!!r,email:!!t,phone:!!s,password:!!i}),a.status(400).json({message:"Missing required fields"});try{console.log("\uD83D\uDD04 Starting registration for:",t),console.log("\uD83D\uDD04 Creating user with userStore...");let e=await l.H.createUser({display_name:r,email:t,phone:s,phone_number:s,password:i});if(!e)throw console.log("❌ User creation returned null"),Error("Failed to create user - userStore returned null");console.log("✅ User created successfully:",{id:e.id,email:e.email,display_name:e.display_name,phone:e.phone});let n=`PV${Math.random().toString(36).substring(2,8).toUpperCase()}`;a.status(201).json({message:"Registration successful! You can now login with your credentials.",userId:e.id,needsVerification:!1,referralCode:n,emailSent:!1})}catch(r){console.error("❌ Registration error:",r);let e=r instanceof Error?r.message:"Internal server error";a.status(500).json({message:e,error:r instanceof Error?r.message:"Unknown error"})}}l=(s.then?(await s)():s)[0],t()}catch(e){t(e)}})},7153:(e,a)=>{var r;Object.defineProperty(a,"x",{enumerable:!0,get:function(){return r}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(r||(r={}))},1802:(e,a,r)=>{e.exports=r(145)}};var a=require("../../../webpack-api-runtime.js");a.C(e);var r=a(a.s=1333);module.exports=r})();